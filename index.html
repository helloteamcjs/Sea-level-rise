<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global warming</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #1a1a1a;
            font-family: 'Source Code Pro', monospace;
            transition: background-color 0.1s ease-out;
        }
        body { 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
        }
        .chart-wrapper {
            width: 90%;
            max-width: 900px;
        }
        #vis-main-container { height: 400px; margin-bottom: 20px; }
        #vis-aux-container { height: 250px; } /* 높이 유지 */
        
        .slider-wrapper {
            margin-top: 10px;
            width: 90%;
            max-width: 900px;
            height: 50px;
            position: relative;
            padding: 0 23px;
            box-sizing: border-box;
        }
        #year-slider-horizontal {
            width: 100%;
            margin: 10px 0 0 0;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: #495057;
            outline: none;
            border-radius: 5px;
        }
        #year-slider-horizontal::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.1s ease-out;
        }
        #year-slider-horizontal::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.1s ease-out;
        }
        #year-display-wrapper {
            position: absolute;
            top: 30px;
            left: 0;
            width: 100%;
            height: 20px;
        }
        #year-display {
            color: white;
            font-size: 1.2em;
            font-style: italic;
            position: absolute;
            transform: translateX(-50%);
        }
        .vg-tooltip {
            font-family: 'Source Code Pro', monospace !important;
            font-size: 11px !important;
        }
    </style>
</head>
<body>
    <div class="chart-wrapper" id="vis-main-container"></div>
    <div class="chart-wrapper" id="vis-aux-container"></div>
    
    <div class="slider-wrapper">
        <input type="range" id="year-slider-horizontal" min="1993" max="2100" step="1" value="1993">
        <div id="year-display-wrapper">
            <span id="year-display">1993</span>
        </div>
    </div>

    <script>
        const embedOpt = { "mode": "vega-lite", "actions": false };
        const specCircularUrl = 'chart_main_final_highlight.json';
        const specLinesUrl = 'chart_aux_final_highlight.json';
        let chartData = [];

        Promise.all([
            fetch(specCircularUrl).then(res => res.json()), 
            fetch(specLinesUrl).then(res => res.json()),
            vegaEmbed('#vis-main-container', specCircularUrl, embedOpt),
            vegaEmbed('#vis-aux-container', specLinesUrl, embedOpt)
        ]).then(([mainSpec, auxSpec, resultCircular, resultLines]) => {
            chartData = mainSpec.data.values;
            const mainView = resultCircular.view;
            const auxView = resultLines.view;
            const slider = document.getElementById('year-slider-horizontal');
            const yearDisplay = document.getElementById('year-display');
            const styleElement = document.createElement('style');
            document.head.appendChild(styleElement);
            const sliderWrapper = document.querySelector('.slider-wrapper');
            
            const onSliderChange = (yearValue) => {
                const year = parseInt(yearValue);
                mainView.signal('year_slider', year).run();
                auxView.signal('selectedYear', year).run();
                
                const bgRatio = (year - 1993) / (2100 - 1993);
                const grayValue = Math.round(26 * (1 - bgRatio));
                document.body.style.backgroundColor = `rgb(${grayValue}, ${grayValue}, ${grayValue})`;
                
                const currentYearData = chartData.find(d => d.Year === year);
                if (currentYearData) {
                    const tempAnomaly = currentYearData.Temp_Anomaly_C;
                    const colorScale = mainView.scale('color');
                    const color = colorScale(tempAnomaly);
                    styleElement.innerHTML = `
                        #year-slider-horizontal::-webkit-slider-thumb { background: ${color}; }
                        #year-slider-horizontal::-moz-range-thumb { background: ${color}; }
                    `;
                }

                const computedStyle = window.getComputedStyle(sliderWrapper);
                const wrapperPadding = parseFloat(computedStyle.paddingLeft);
                const sliderRatio = (year - 1993) / (2100 - 1993);
                const sliderTrackWidth = slider.offsetWidth;
                const thumbWidth = 20;

                const thumbPosition = sliderRatio * (sliderTrackWidth - thumbWidth) + (thumbWidth / 2);
                
                yearDisplay.style.left = wrapperPadding + thumbPosition + 'px';
                yearDisplay.textContent = year;
            };

            slider.addEventListener('input', (event) => {
                onSliderChange(event.target.value);
            });
            
            setTimeout(() => onSliderChange(slider.value), 100);
            window.addEventListener('resize', () => onSliderChange(slider.value));
        }).catch(console.error);
    </script>
</body>
</html>